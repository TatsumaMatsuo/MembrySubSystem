# システムアーキテクチャ・I/O関連図

MembrySubSystem のシステム構成、I/O関連図、テーブル関連図です。

## 目次

1. [システム全体構成](#システム全体構成)
2. [I/O関連図](#io関連図)
3. [テーブル関連図（ER図）](#テーブル関連図er図)
4. [画面・API・テーブル対応表](#画面apiテーブル対応表)
5. [データフロー図](#データフロー図)

---

## システム全体構成

```
┌─────────────────────────────────────────────────────────────────────────┐
│                              ユーザー                                    │
│                         (ブラウザ / PC)                                  │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                           Next.js Frontend                              │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐       │
│  │   /top      │ │  /baiyaku   │ │   /eigyo    │ │  /master    │       │
│  │  TOPページ  │ │  売約管理   │ │  営業部門   │ │  マスタ管理  │       │
│  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘       │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐       │
│  │  /seizou    │ │  /upload    │ │  /settings  │ │   /admin    │       │
│  │   製造部門  │ │  アップロード│ │    設定     │ │   管理者    │       │
│  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘       │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                          Next.js API Routes                             │
│                           /api/*  (38 endpoints)                        │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                    ┌───────────────┼───────────────┐
                    ▼               ▼               ▼
┌─────────────────────────┐ ┌─────────────┐ ┌─────────────────────────┐
│    Lark Base API        │ │ Lark Calendar│ │      NextAuth           │
│  (テーブルデータ)        │ │    API      │ │     (認証/認可)          │
│                         │ │ (予定取得)   │ │                         │
│  ┌─────────┐ ┌────────┐ │ └─────────────┘ └─────────────────────────┘
│  │ project │ │ master │ │
│  │  Base   │ │  Base  │ │
│  └─────────┘ └────────┘ │
└─────────────────────────┘
```

---

## I/O関連図

### 画面別 I/O フロー

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          TOPページ (/top)                               │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌──────────────────┐    ┌──────────────────┐    ┌──────────────────┐  │
│  │ DailyQuizWidget  │    │TodayScheduleWidget│   │   Sidebar        │  │
│  └────────┬─────────┘    └────────┬─────────┘    └────────┬─────────┘  │
│           │                       │                       │            │
│           ▼                       ▼                       ▼            │
│  ┌──────────────────┐    ┌──────────────────┐    ┌──────────────────┐  │
│  │   /api/quiz      │    │/api/calendar/today│   │/api/menu-permission│ │
│  └────────┬─────────┘    └────────┬─────────┘    └────────┬─────────┘  │
│           │                       │                       │            │
│           ▼                       ▼                       ▼            │
│  ┌──────────────────┐    ┌──────────────────┐    ┌──────────────────┐  │
│  │  QUIZ_MASTER     │    │  Lark Calendar   │    │ MENU_DISPLAY     │  │
│  │  QUIZ_ANSWER_    │    │      API         │    │ FUNCTION_PLACEMENT│ │
│  │  HISTORY         │    │                  │    │ GROUP_PERMISSION │  │
│  └──────────────────┘    └──────────────────┘    │ USER_PERMISSION  │  │
│                                                  └──────────────────┘  │
└─────────────────────────────────────────────────────────────────────────┘


┌─────────────────────────────────────────────────────────────────────────┐
│                     売約詳細ページ (/baiyaku/[seiban])                   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  入力: 製番（seiban）                                                    │
│           │                                                             │
│           ▼                                                             │
│  ┌────────────────────────────────────────────────────────────────┐    │
│  │                      API 呼び出し                               │    │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │    │
│  │  │/api/baiyaku-    │  │  /api/documents │  │/api/customer-   │ │    │
│  │  │detail           │  │                 │  │requests         │ │    │
│  │  └────────┬────────┘  └────────┬────────┘  └────────┬────────┘ │    │
│  │           │                    │                    │          │    │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │    │
│  │  │/api/quality-    │  │  /api/gantt     │  │/api/cost-       │ │    │
│  │  │issues           │  │                 │  │analysis         │ │    │
│  │  └────────┬────────┘  └────────┬────────┘  └────────┬────────┘ │    │
│  │           │                    │                    │          │    │
│  │  ┌─────────────────┐  ┌─────────────────┐                      │    │
│  │  │/api/construction│  │/api/documents/  │                      │    │
│  │  │-spec            │  │history          │                      │    │
│  │  └────────┬────────┘  └────────┬────────┘                      │    │
│  └───────────┼────────────────────┼───────────────────────────────┘    │
│              │                    │                                     │
│              ▼                    ▼                                     │
│  ┌────────────────────────────────────────────────────────────────┐    │
│  │                      Lark Tables                                │    │
│  │  BAIYAKU │ PROJECT_DOCUMENTS │ CUSTOMER_REQUESTS                │    │
│  │  QUALITY_ISSUES │ DOCUMENT_HISTORY │ 製番原価テーブル           │    │
│  └────────────────────────────────────────────────────────────────┘    │
│                                                                         │
│  出力: 売約詳細画面（タブ切替で各情報表示）                              │
└─────────────────────────────────────────────────────────────────────────┘


┌─────────────────────────────────────────────────────────────────────────┐
│                     営業部KPI (/eigyo/sales-kpi)                        │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                    KPI入力フォーム                               │   │
│  │  ・売上目標 ・粗利目標 ・テント倉庫棟数 ・WEB問合せ件数 etc.      │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│           │                                                             │
│           ▼                                                             │
│  ┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐   │
│  │  GET (読込)      │     │  POST (新規)    │     │  PUT (更新)     │   │
│  │  /api/sales-kpi │     │  /api/sales-kpi │     │  /api/sales-kpi │   │
│  └────────┬────────┘     └────────┬────────┘     └────────┬────────┘   │
│           │                       │                       │            │
│           └───────────────────────┼───────────────────────┘            │
│                                   ▼                                     │
│                      ┌─────────────────────┐                           │
│                      │     SALES_KPI       │                           │
│                      │    (Lark Table)     │                           │
│                      └─────────────────────┘                           │
└─────────────────────────────────────────────────────────────────────────┘


┌─────────────────────────────────────────────────────────────────────────┐
│                  書類アップロード (/upload/*)                            │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  入力: Excel/PDFファイル                                                │
│           │                                                             │
│           ▼                                                             │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                    ファイル解析                                  │   │
│  │  ・xlsx パース ・PDF サムネイル生成                              │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│           │                                                             │
│           ▼                                                             │
│  ┌──────────────────────┐     ┌──────────────────────┐                 │
│  │/api/upload/order-    │     │/api/documents/upload │                 │
│  │backlog               │     │                      │                 │
│  └──────────┬───────────┘     └──────────┬───────────┘                 │
│             │                            │                              │
│             ▼                            ▼                              │
│  ┌──────────────────────┐     ┌──────────────────────┐                 │
│  │      BAIYAKU         │     │  PROJECT_DOCUMENTS   │                 │
│  │   (受注残更新)        │     │  DOCUMENT_HISTORY    │                 │
│  └──────────────────────┘     └──────────────────────┘                 │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## テーブル関連図（ER図）

### メニュー権限システム

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        メニュー権限システム ER図                          │
└─────────────────────────────────────────────────────────────────────────┘

┌──────────────────────┐         ┌──────────────────────┐
│   MENU_DISPLAY       │         │ FUNCTION_PLACEMENT   │
│  (メニュー表示マスタ)  │         │  (機能配置マスタ)     │
├──────────────────────┤         ├──────────────────────┤
│ PK メニューID         │◄────────│ FK 配置メニューID     │
│    メニュー名         │    1:N  │ PK プログラムID       │
│    階層レベル         │         │    プログラム名称     │
│ FK 親メニューID       │──┐      │    URLパス           │
│    表示順            │  │      │    表示順            │
│    アイコン          │  │      │    有効フラグ        │
│    有効フラグ        │  │      └──────────────────────┘
└──────────────────────┘  │
          ▲               │
          │ 自己参照      │
          └───────────────┘
          (第1階層→第2階層)


┌──────────────────────┐         ┌──────────────────────┐
│  GROUP_PERMISSION    │         │   USER_PERMISSION    │
│ (グループ権限マスタ)  │         │  (個別権限マスタ)     │
├──────────────────────┤         ├──────────────────────┤
│ PK グループID         │         │ PK 社員ID            │
│    グループ名         │         │    社員名            │
│    対象種別          │         │    対象種別          │
│ FK 対象ID            │─────┐   │ FK 対象ID           │─────┐
│    許可フラグ        │     │   │    許可フラグ        │     │
│    更新日時          │     │   │    更新日時          │     │
└──────────────────────┘     │   └──────────────────────┘     │
                             │                               │
                             ▼                               ▼
              ┌──────────────────────────────────────────────────┐
              │   メニューID or プログラムID を参照               │
              │   (MENU_DISPLAY.メニューID or                    │
              │    FUNCTION_PLACEMENT.プログラムID)              │
              └──────────────────────────────────────────────────┘


┌──────────────────────┐
│      EMPLOYEES       │
│    (社員マスタ)       │
├──────────────────────┤
│ PK 社員コード         │◄─────── USER_PERMISSION.社員ID
│    社員名            │
│    メールアドレス     │
│    部署              │◄─────── GROUP_PERMISSION.グループID
│    退職者フラグ       │
└──────────────────────┘
```

### 売約管理システム

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         売約管理システム ER図                            │
└─────────────────────────────────────────────────────────────────────────┘

                    ┌──────────────────────┐
                    │       BAIYAKU        │
                    │     (売約情報)        │
                    ├──────────────────────┤
                    │ PK 製番              │
                    │    担当者            │
                    │    品名              │
                    │    品名2             │
                    │    受注日            │
                    │    受注金額          │
                    │    施工開始日         │
                    │    得意先宛名1        │
                    │    得意先宛名2        │
                    └──────────┬───────────┘
                               │
           ┌───────────────────┼───────────────────┐
           │                   │                   │
           ▼                   ▼                   ▼
┌──────────────────┐ ┌──────────────────┐ ┌──────────────────┐
│CUSTOMER_REQUESTS │ │  QUALITY_ISSUES  │ │PROJECT_DOCUMENTS │
│ (顧客要求事項)    │ │   (品質改善)      │ │   (案件書庫)     │
├──────────────────┤ ├──────────────────┤ ├──────────────────┤
│ FK 製番          │ │ FK 製番          │ │ FK 製番          │
│    申請日        │ │    発生日        │ │    書類種別      │
│    要求区分      │ │    発見部署      │ │    部署          │
│    本文          │ │    起因部署      │ │    添付ファイル   │
└──────────────────┘ │    不具合タイトル │ │    更新日時      │
                     │    不具合本文     │ │    バージョン     │
                     └──────────────────┘ └────────┬─────────┘
                                                    │
                                                    │ 1:N
                                                    ▼
                                          ┌──────────────────┐
                                          │ DOCUMENT_HISTORY │
                                          │   (更新履歴)      │
                                          ├──────────────────┤
                                          │ FK 製番          │
                                          │ FK 書類種別      │
                                          │    操作種別      │
                                          │    ファイル名     │
                                          │    操作者        │
                                          │    操作日時      │
                                          │    備考          │
                                          │    変更前        │
                                          │    変更後        │
                                          └──────────────────┘


┌──────────────────────┐
│      製番原価         │
│  (tbl7lMDstBVYxQKd)  │
├──────────────────────┤
│ FK 製番              │◄─────── BAIYAKU.製番
│    原価実績          │
│    原価予定          │
│    予算              │
│    ...               │
└──────────────────────┘
```

### KPI・分析システム

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         KPI・分析システム ER図                           │
└─────────────────────────────────────────────────────────────────────────┘

┌──────────────────────┐         ┌──────────────────────┐
│     COMPANY_KPI      │         │      SALES_KPI       │
│    (全社KPI)         │         │    (営業部KPI)        │
├──────────────────────┤         ├──────────────────────┤
│ PK 期                │         │ PK 期                │
│    売上目標          │         │    期間開始日         │
│    月次売上目標       │         │    期間終了日         │
│    売上原価目標       │         │    売上目標          │
│    販管費目標        │         │    月次売上目標       │
│    営業利益目標       │         │    粗利目標          │
│    変動費目標        │         │    粗利率            │
│    固定費目標        │         │    テント倉庫販売棟数  │
│    人員計画          │         │    WEB問合せ件数      │
│    備考              │         │    Aランク顧客目標    │
└──────────────────────┘         │    クレーム上限件数    │
                                 │    備考              │
                                 └──────────────────────┘


┌──────────────────────┐         ┌──────────────────────┐
│     QUIZ_MASTER      │         │ QUIZ_ANSWER_HISTORY  │
│   (クイズマスタ)      │         │  (クイズ回答履歴)     │
├──────────────────────┤         ├──────────────────────┤
│ PK クイズID          │◄────────│ FK クイズID          │
│    問題文            │    1:N  │    ユーザーメール     │
│    選択肢A           │         │    ユーザー名         │
│    選択肢B           │         │    回答日            │
│    選択肢C           │         │    回答              │
│    正解              │         │    正誤              │
│    解説              │         │    獲得ポイント       │
│    カテゴリ          │         │    期                │
│    有効フラグ        │         │    作成日時          │
└──────────────────────┘         └──────────────────────┘
```

---

## 画面・API・テーブル対応表

### 一覧

| 画面 | URL | API | テーブル（R=読/W=書） |
|------|-----|-----|----------------------|
| TOP | `/top` | `/api/quiz`, `/api/calendar/today` | QUIZ_MASTER(R), QUIZ_ANSWER_HISTORY(R/W) |
| 売約検索 | `/baiyaku/kensaku` | `/api/baiyaku` | BAIYAKU(R) |
| 売約詳細 | `/baiyaku/[seiban]` | `/api/baiyaku-detail`, `/api/documents`, `/api/customer-requests`, `/api/quality-issues`, `/api/gantt`, `/api/cost-analysis`, `/api/construction-spec`, `/api/documents/history` | BAIYAKU(R), PROJECT_DOCUMENTS(R), CUSTOMER_REQUESTS(R), QUALITY_ISSUES(R), DOCUMENT_HISTORY(R), 製番原価(R) |
| 全社KPI | `/eigyo/company-kpi` | `/api/company-kpi` | COMPANY_KPI(R/W) |
| 営業部KPI | `/eigyo/sales-kpi` | `/api/sales-kpi` | SALES_KPI(R/W) |
| 売上BI | `/eigyo/sales-bi` | `/api/sales-analysis`, `/api/sales-budget`, `/api/sales-dashboard` | BAIYAKU(R), 製番原価(R) |
| 赤字分析 | `/eigyo/deficit-analysis` | `/api/deficit-analysis` | BAIYAKU(R) |
| 納期変更 | `/seizou/delivery-change` | `/api/delivery-change` | 納期変更テーブル(R) |
| 社員管理 | `/master/users` | `/api/master/employees` | EMPLOYEES(R) |
| 権限管理 | `/master/menu-permissions` | `/api/master/menu-permissions`, `/api/menu-permission` | USER_PERMISSIONS(R/W) |
| 受注残UP | `/upload/order-backlog` | `/api/upload/order-backlog` | BAIYAKU(W) |
| クイズ管理 | `/admin/quiz-import` | `/api/quiz/import` | QUIZ_MASTER(W) |

---

## データフロー図

### 全体データフロー

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           外部データソース                               │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐    │
│  │  Excel      │  │    PDF     │  │Lark Calendar│  │ Lark Groups │    │
│  │ (受注残)    │  │  (書類)     │  │   (予定)    │  │  (部門)     │    │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘    │
└─────────┼────────────────┼────────────────┼────────────────┼───────────┘
          │                │                │                │
          ▼                ▼                ▼                ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                          Next.js API Layer                              │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                       データ変換・検証                           │   │
│  │  ・Excel パース (xlsx)                                          │   │
│  │  ・PDF サムネイル生成 (pdfjs-dist)                              │   │
│  │  ・画像差分比較 (pixelmatch)                                    │   │
│  │  ・AI 分析 (Anthropic API)                                      │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                    │                                    │
└────────────────────────────────────┼────────────────────────────────────┘
                                     │
                                     ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                           Lark Base API                                 │
│                                                                         │
│  ┌─────────────────────────────┐  ┌─────────────────────────────┐      │
│  │       Project Base          │  │        Master Base          │      │
│  │  (LARK_BASE_TOKEN)          │  │  (LARK_BASE_TOKEN_MASTER)   │      │
│  │                             │  │                             │      │
│  │  ・BAIYAKU (売約情報)        │  │  ・EMPLOYEES (社員)         │      │
│  │  ・PROJECT_DOCUMENTS        │  │  ・MENU_DISPLAY             │      │
│  │  ・CUSTOMER_REQUESTS        │  │  ・FUNCTION_PLACEMENT       │      │
│  │  ・QUALITY_ISSUES           │  │  ・GROUP_PERMISSION         │      │
│  │  ・DOCUMENT_HISTORY         │  │  ・USER_PERMISSION          │      │
│  │  ・COMPANY_KPI              │  │                             │      │
│  │  ・SALES_KPI                │  │                             │      │
│  │  ・QUIZ_MASTER              │  │                             │      │
│  │  ・QUIZ_ANSWER_HISTORY      │  │                             │      │
│  │  ・製番原価                  │  │                             │      │
│  │  ・納期変更                  │  │                             │      │
│  └─────────────────────────────┘  └─────────────────────────────┘      │
└─────────────────────────────────────────────────────────────────────────┘
                                     │
                                     ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                              出力                                       │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐    │
│  │   画面表示   │  │  グラフ     │  │   PDF      │  │   Excel     │    │
│  │  (React)    │  │ (Recharts) │  │  (出力)     │  │   (出力)    │    │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘    │
└─────────────────────────────────────────────────────────────────────────┘
```

### 認証・認可フロー

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          認証・認可フロー                                │
└─────────────────────────────────────────────────────────────────────────┘

ユーザー
    │
    ▼
┌──────────────────┐
│   /auth/signin   │
│  (ログイン画面)   │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐         ┌──────────────────┐
│    NextAuth      │◄───────►│   Lark OAuth     │
│  (認証プロバイダ) │         │   (SSO認証)       │
└────────┬─────────┘         └──────────────────┘
         │
         │ セッション確立
         ▼
┌──────────────────┐
│   Session        │
│  ・employeeId    │
│  ・employeeName  │
│  ・department    │
│  ・email         │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│ /api/menu-       │
│ permission       │
└────────┬─────────┘
         │
         ├─────────────────────────┐
         ▼                         ▼
┌──────────────────┐     ┌──────────────────┐
│ USER_PERMISSION  │     │ GROUP_PERMISSION │
│ (個別権限チェック) │     │ (グループ権限)    │
└────────┬─────────┘     └────────┬─────────┘
         │                        │
         │  個別権限あり？         │ なければ
         │  YES → 個別権限適用     │ グループ権限適用
         │                        │
         └────────────┬───────────┘
                      │
                      ▼
         ┌──────────────────────┐
         │  許可メニュー構造     │
         │  (Sidebar表示)       │
         └──────────────────────┘
```

---

*最終更新: 2026-01-17*
